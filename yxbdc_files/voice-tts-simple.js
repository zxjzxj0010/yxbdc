(function(){if(!window._ttsTasks){window._ttsTasks={};}
if(!window._ttsTextToSegmentId){window._ttsTextToSegmentId={};}
function generateSegmentId(text){if(text&&typeof text==='string'){const trimmedText=text.trim();const cachedSegmentId=window._ttsTextToSegmentId[trimmedText];if(cachedSegmentId&&!window._ttsTasks[cachedSegmentId]){return cachedSegmentId;}}
const newSegmentId='tts_'+Math.random().toString(36).substr(2,4);if(text&&typeof text==='string'){const trimmedText=text.trim();window._ttsTextToSegmentId[trimmedText]=newSegmentId;}
return newSegmentId;}
function cleanupTask(segmentId){const task=window._ttsTasks[segmentId];if(task){if(task.timeoutId){clearTimeout(task.timeoutId);}
delete window._ttsTasks[segmentId];}}
function playTTS(text,options={}){return new Promise((resolve,reject)=>{if(!text||typeof text!=='string'||!text.trim()){reject(new Error('播放文本不能为空'));return;}
const segmentId=generateSegmentId(text);window._ttsTasks[segmentId]={resolve:(result)=>{cleanupTask(segmentId);resolve(result);},reject:(error)=>{cleanupTask(segmentId);reject(error);},timeoutId:null,onStartReceived:false};const task=window._ttsTasks[segmentId];const timeoutId=setTimeout(()=>{const currentTask=window._ttsTasks[segmentId];if(currentTask&&!currentTask.onStartReceived){currentTask.reject(new Error('TTS播放超时：4秒内未收到播放开始事件'));}},4000);task.timeoutId=timeoutId;const params={sentences:[{text:text.trim(),id:'sentence_0'}],speakerId:15014,source:'mini_app',segmentId:segmentId,lang:options.lang||'auto',pinyin:options.pinyin||''};const voiceTypeMap={'fairy_tale':{sub_task_id:'fairy_tale',task_id:'story_tts'},'short_play':{sub_task_id:'short_play',task_id:'story_tts'},'common':{sub_task_id:'',task_id:'common_tts'}};if(options.voiceType&&voiceTypeMap[options.voiceType]){params.extensions=voiceTypeMap[options.voiceType];}
window.CandyJar.call('TTSPlayer','play',params,function(successResult){},function(error){const currentTask=window._ttsTasks[segmentId];if(currentTask){const errorMsg=(error&&error.message)||'TTS播放请求失败';currentTask.reject(new Error(errorMsg));}});});}
function stopAllTTS(){if(!Object.keys(window._ttsTasks).length)return;const segmentIds=Object.keys(window._ttsTasks);segmentIds.forEach(segmentId=>{const task=window._ttsTasks[segmentId];if(task){task.reject(new Error('TTS播放被停止'));}});window.CandyJar.call('TTSPlayer','stop',{},function(){},function(error){console.log('stopAllTTS失败:',error);});}
if(!window._ttsEventListenersInitialized){window._ttsEventListenersInitialized=true;window.document.addEventListener("CandyJar.TTSPlayer.OnStart",function(event){const segmentId=event.segmentId;const task=window._ttsTasks[segmentId];if(task){task.onStartReceived=true;if(task.timeoutId){clearTimeout(task.timeoutId);task.timeoutId=null;}}});window.document.addEventListener("CandyJar.TTSPlayer.OnComplete",function(event){const segmentId=event.segmentId;const task=window._ttsTasks[segmentId];if(task){task.resolve();}});window.document.addEventListener("CandyJar.TTSPlayer.OnStop",function(event){const segmentId=event.segmentId;const task=window._ttsTasks[segmentId];if(task){task.reject(new Error('TTS播放被停止'));}});window.document.addEventListener("CandyJar.TTSPlayer.OnError",function(event){const segmentId=event.segmentId;const task=window._ttsTasks[segmentId];if(task){const errorMsg=(event.error&&event.error.message)||'TTS播放失败';task.reject(new Error(errorMsg));}});}
window.playTTS=playTTS;window.stopAllTTS=stopAllTTS;})();